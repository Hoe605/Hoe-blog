---
import type { CollectionEntry } from "astro:content";
import BaseHead from "#src/components/astro/BaseHead.astro";
import Footer from "#src/components/astro/Footer.astro";
import Header from "#src/components/astro/Header.astro";
import FormattedDate from "#src/components/astro/FormattedDate.astro";
import Sidebar from "#src/components/vue/Sidebar.vue";
import { getCollection } from "astro:content";
import { SITE_TITLE, SITE_DESCRIPTION } from "#src/consts.ts";

type Props = CollectionEntry<"blog">["data"];

const { title, description, pubDate, updatedDate, heroImage } = Astro.props;

// Fetch posts for Sidebar stats
const allPosts = await getCollection("blog");
const uniqueTags = new Set();
allPosts.forEach((post) => {
	post.data.tags?.forEach((tag) => uniqueTags.add(tag));
});
---

<html lang="zh-CN">
	<head>
		<BaseHead title={title} description={description} />
		<style>
			main {
				width: 100%;
				max-width: 100%;
				margin: 0;
			}
			.hero-container {
				width: 100%;
				height: 60vh;
				min-height: 400px;
				position: relative;
				overflow: hidden;
				border-bottom: 1px solid var(--color-border);
			}
			.hero-bg {
				width: 100%;
				height: 100%;
				object-fit: cover;
				position: absolute;
				top: 0;
				left: 0;
				z-index: 1;
				filter: brightness(0.9); /* Lighter than before */
			}
			.hero-overlay {
				position: absolute;
				bottom: 0;
				left: 0;
				width: 100%;
				z-index: 2;
				background: linear-gradient(
					to top,
					var(--color-bg) 20%,
					transparent 100%
				);
				padding: 4rem 2rem 6rem; /* Extra bottom padding for overlap */
				display: flex;
				justify-content: center;
			}
			.hero-content {
				width: 100%;
				max-width: 900px;
				text-align: center;
			}
			@media (max-width: 960px) {
				.hero-content {
					transform: none;
				}
			}
			.hero-title {
				font-size: 3.5rem;
				font-weight: 900;
				line-height: 1.2;
				color: var(--color-text);
				margin-bottom: 1rem;
				text-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
			}
			.hero-meta {
				display: flex;
				justify-content: center;
				gap: 1.5rem;
				color: var(--color-text-muted);
				font-size: 1.1rem;
			}

			.article-layout {
				max-width: 1280px;
				margin: -80px auto 4rem;
				position: relative;
				z-index: 10;
				padding: 0 2rem;
				padding-left: 6rem; /* Shift entire grid right */
				display: grid;
				grid-template-columns: 1fr 300px;
				gap: 2rem;
				align-items: start;
			}

			.content-card {
				background: var(--color-bg-card);
				border-radius: 20px;
				padding: 3rem 4rem;
				box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
				border: 1px solid var(--color-border);
				min-width: 0;
			}

			.sidebar-container {
				position: sticky;
				top: 2rem;
			}

			/* Typography Enhancements */
			.prose {
				max-width: 100%;
				font-size: 1.1rem;
				line-height: 1.8;
				color: var(--color-text);
			}
			.prose :global(h2) {
				font-size: 2rem;
				font-weight: 800;
				margin-top: 2.5rem;
				margin-bottom: 1rem;
				color: var(--color-primary);
				border-bottom: 1px solid var(--color-border);
				padding-bottom: 0.5rem;
			}
			.prose :global(h3) {
				font-size: 1.5rem;
				font-weight: 700;
				margin-top: 2rem;
				margin-bottom: 0.8rem;
				color: var(--color-text);
			}
			.prose :global(p) {
				margin-bottom: 1.5rem;
			}
			.prose :global(blockquote) {
				border-left: 4px solid var(--color-primary);
				margin: 2rem 0;
				font-style: italic;
				color: var(--color-text-muted);
				background: color-mix(
					in srgb,
					var(--color-primary),
					transparent 90%
				);
				padding: 1.5rem;
				border-radius: 0 8px 8px 0;
			}
			.prose :global(code) {
				background: var(--color-bg);
				padding: 0.2rem 0.4rem;
				border-radius: 4px;
				font-size: 0.9em;
				color: var(--color-primary);
				border: 1px solid var(--color-border);
			}
			.prose :global(pre) {
				background: var(--color-bg) !important;
				border: 1px solid var(--color-border);
				border-radius: 8px;
				margin: 2rem 0;
				padding: 1.5rem;
			}
			.prose :global(img) {
				border-radius: 12px;
				box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
				margin: 2rem 0;
			}

			@media (max-width: 960px) {
				.article-layout {
					grid-template-columns: 1fr;
					margin-top: -40px;
					padding: 0 1rem; /* Reset padding */
				}
				.sidebar-container {
					display: none;
				}
				.content-card {
					padding: 2rem 1.5rem;
				}
				.hero-title {
					font-size: 2.2rem;
				}
			}
		</style>
	</head>

	<body>
		<Header />
		<main>
			<div class="hero-container">
				{
					heroImage && (
						<img
							src={
								typeof heroImage === "string"
									? heroImage
									: heroImage.src
							}
							alt=""
							class="hero-bg"
						/>
					)
				}
				<div class="hero-overlay">
					<div class="hero-content">
						<h1 class="hero-title">{title}</h1>
						<div class="hero-meta">
							<FormattedDate date={pubDate} />
							{
								updatedDate && (
									<div class="last-updated-on">
										Last updated on{" "}
										<FormattedDate date={updatedDate} />
									</div>
								)
							}
						</div>
					</div>
				</div>
			</div>

			<div class="article-layout">
				<article class="content-card">
					<div class="prose">
						<slot />
					</div>
				</article>
				<aside class="sidebar-container">
					<Sidebar
						client:load
						postCount={allPosts.length}
						tagCount={uniqueTags.size}
					/>
				</aside>
			</div>
		</main>
		<Footer />
	</body>
</html>
